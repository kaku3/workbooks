# エクスポート・インポート仕様書

## 概要

報告用のエクセルファイルへのエクスポート、エクセルファイルからのインポート機能を持つものとする。

## テンプレートファイル

`trak-data/trak.xlsx` をテンプレートとする。
テンプレートの書式は維持するものとし、Trak では必要項目だけの読み取り・書き込みを行う。

### テンプレートファイルの管理

1. テンプレートファイルの配置
   - アプリケーションインストール時に配置
   - 上書きや削除を防ぐため、読み取り専用として配置

2. テンプレートファイルの構成
   - プロジェクト情報シート
   - チケット一覧シート
   - スタイル定義（セル書式、条件付き書式など）

## エクスポート

### エクスポート手順

1. メインページのツールバーに「エクスポート」ボタンを配置
2. エクスポートボタンクリック時に、最新データをExcelファイルとしてダウンロード
3. ダウンロードされたファイル名は「trak_YYYYMMDD_HHMMSS.xlsx」とする

### エクスポート対象データ

- プロジェクト情報
- 現在表示されているチケット一覧（フィルタ適用済み）

### エクスポート時の制御

1. 出力ファイルの制御
   - テンプレートファイルを基に新規ファイルを生成
   - スタイル・書式設定を維持
   - シート保護設定を継承

2. エラー処理
   - テンプレートファイルが存在しない場合はエラー
   - テンプレートファイルが破損している場合はエラー
   - 出力先に書き込み権限がない場合はエラー

## インポート

### インポート手順

1. メインページのツールバーに「インポート」ボタンを配置
2. インポートボタンクリック時に、ファイル選択ダイアログを表示
3. 選択されたファイルを読み込み、データを更新
4. 処理結果を通知
   - 成功：更新されたチケット数を表示
   - エラー：エラー内容を表示

### インポート時の制御

- プロジェクト情報（id）が一致しない場合はエラー
- 既存チケットの更新は、以下のいずれかの条件で対象を特定
  - チケットIDが一致
  - タグとタイトルが完全一致
- 新規チケット作成時は、チケットIDを自動採番

## 書式

### プロジェクト情報(configs/project.json)

- D1 : id
- D2 : name
- I1 : beginDate
- I2 : endDate

### チケット情報(trackings/{チケットID}.json)

- 4行目ヘッダ
  - A : チケットID
  - B : tags[0]
  - C : tags[1]
  - D : title
  - E : assignees[]
  - F : estimate
  - G : progress
  - H : status
  - I : startDate
  - J : dueDate

- 5行目からデータ

#### 変換

- A : チケットID
- 空欄の場合はタグとタイトルでチケットを検索
    - 検索結果あり : 検索できたチケットを更新対象として処理
    - 検索結果なし : import日をIDとして新規チケットを発行
      - チケットIDが重複しないように hhmmss 部分を240000 以降の連番で登録
      - 新規チケットの createdAt は現在日時を設定
      - 新規チケットの creator は操作ユーザーを設定
- B : tags[0]
  - タグ.name ⇔ タグ.id 変換を行う
    - エクセル : タグ.name
    - 保存データ : タグ.id
- C : tags[1]
  - タグ.name ⇔ タグ.id 変換を行う
    - エクセル : タグ.name
    - 保存データ : タグ.id
- D : title
- E : assignees[]
  - ユーザー.name ⇔ ユーザー.id 変換を行う
    - エクセル : ユーザー.name
    - 保存データ : ユーザー.id
  - 複数データ
    - エクセル : [:]区切り
    - 保存データ : 配列
- F : estimate
  - 日 ⇔ 時変換を行う
    - エクセル : 人日単位(d)
    - 保存データ : 人時単位(h)
- G : progress
  - 変換なし
- H : status
  - ステータス.name ⇔ ステータス.id 変換を行う
    - エクセル : ステータス.name
    - 保存データ : ステータス.id
- I : startDate
  - エクセル日付 ⇔ yyyy/MM/dd 変換を行う
- J : dueDate
  - エクセル日付 ⇔ yyyy/MM/dd 変換を行う

## エラー処理

### インポート時のエラーチェック

1. ファイル形式チェック
   - Excelファイル（.xlsx）以外はエラー
   - テンプレートと異なる形式の場合はエラー

2. 必須項目チェック
   - プロジェクトID
   - チケットタイトル

3. データ整合性チェック
   - 存在しないタグ名
   - 存在しないステータス名
   - 存在しないユーザー名
   - 不正な日付形式
   - 不正な工数値（負数など）

### エラー発生時の処理

- エラーが発生した場合、処理を中断
- エラーの詳細をユーザーに表示
  - エラーが発生した行番号
  - エラーの内容
  - 期待される入力形式

## セキュリティ考慮事項

1. アクセス制御
   - インポート・エクスポート機能は認証済みユーザーのみ利用可能
   - インポートによる更新は、チケットの編集権限のあるユーザーのみ可能

2. データ検証
   - インポートデータのサイズ制限（10MB以下）
   - ファイル形式の厳密なチェック
