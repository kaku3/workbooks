<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>kaku3 - QiitaË®ò‰∫ã</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      margin: 0;
      padding: 0;
      .nav {
        font-size: .9rem;
        min-width: 380px;
        background-color: #ccc;

        height: 100vh;
        overflow: auto;

        ul {
          margin: 0;
          padding: 0;
          list-style: none;
        }

        .tag-menu-section {
          .name {
            cursor: pointer;
            padding: .25rem;
            color: white;
            background-color: #222;
            border-bottom: 1px solid #888;

            transition: all .25s ease;
            &:hover {
              filter: brightness(1.5);
            }
          }
          .tags-container {
            cursor: pointer;
            margin-left: .5rem;

            .tag-menu-tag a {
              display: flex;
              justify-content: space-between;
              padding: .1rem .25rem;
              font-size: .8rem;
              background-color: #eee;
              border-bottom: 1px solid #ccc;

              transition: all .25s ease;
              &:hover {
                filter: brightness(1.5);
              }
            }
          }
        }
      }
      main {
        height: 100vh;
        overflow: auto;
      }
    }
    .title {
      margin: 0;
      padding: .5rem;
    }

    .tag-sections {
      cursor: pointer;
      display: flex;
      flex-wrap: wrap;
      list-style: none;
      padding: .25rem;
      margin: .5rem;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      li {
        .tag-section {
          margin: .25rem;
          padding: .25rem 1rem;
          font-size: .8rem;
          letter-spacing: .01rem;
          white-space: nowrap;
          border-radius: 4px;
          border: 1px solid rgba(0,0,0, .25);
        }
      }
    }
    .keyword-filter {
      display: flex;
      margin-top: .25rem;
      padding: .5rem;
      #keyword {
        flex-grow: 1;
        padding: .25rem;
      }
    }

    [role=articles] {
      margin-top: 1rem;
      label {
        display: block;
        padding: .25rem .5rem;
        font-weight: bold;
        letter-spacing: .1rem;
        color: #222;
        background-color: #eee;
        border-bottom: 1px solid #222;
      }
      .articles-container {
        list-style: none;
        margin: 0;
        padding: 0;
        li {
          border-bottom: 1px solid #ccc;

          a {
            cursor: pointer;
            display: block;
            padding: .5rem;
            font-size: 1rem;
            color: #222;
            text-decoration: none;

            transition: all .25s ease;
            &:hover {
              background-color: #eee;
            }

            [role=qiita-link] {
              display: block;
              padding: .5rem;
            }
            .article-tags-container {
              display: flex;
              flex-wrap: wrap;
              justify-content: end;
              list-style: none;
              margin: 0;
              padding: 0;
              gap: .25rem;
              li {
                padding: .1rem .5rem;
                font-size: .7rem;
                color: white;
                background-color: #888;
                border-radius: 8px;
              }
            }
          }
        }
      }
    }

    .recommends-container {
      margin-top: 2rem;

      > label {
        display: block;
        padding: .5rem;
        color: white;
        background-color: #222;
      }
    }

    footer {
      padding: .5rem;
      background-color: #eee;

      .section {
        font-weight: bold;
      }
      .links {
        margin: 0;
        padding: 0;
        list-style: none;
        li {
          a {
            color: black;
            text-decoration: none;
            &:hover {
              text-decoration: underline;
            }
          }
        }
      }
      .copyright {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <ul role="tag-menu"></ul>
    </nav>
    <main class="main">
      <h1 class="title">kaku3 - QiitaË®ò‰∫ã‰∏ÄË¶ß</h1>
      <form class="keyword-filter">
        <span>üîé</span><input id="keyword" type="text" placeholder="Ê§úÁ¥¢„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ"/>
      </form>
      <ul role="tag-sections" class="tag-sections"></ul>

      <section role="articles" class="search-result"></section>
      <section class="recommends-container">
        <label>„Åä„Åô„Åô„ÇÅË®ò‰∫ã</label>
        <section role="articles" class="recommend-1"></section>
        <section role="articles" class="recommend-2"></section>
        <section role="articles" class="recommend-3"></section>
        <section role="articles" class="recommend-4"></section>
        <section role="articles" class="recommend-5"></section>
      </section>
      <footer>
        <div class="section">links</div>
        <ul class="links">
          <li>
            <a href="https://github.com/kaku3/workbooks">„Ç®„É≥„Ç∏„Éã„Ç¢„ÅÆ„Åü„ÇÅ„ÅÆ„Åä‰ªï‰∫ãÂïèÈ°åÈõÜ</a>
          </li>
        </ul>
        <div class="copyright">&copy; kaku3</div>
      </footer>
    </main>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
  <script src="./data/articles.js"></script>
  <script src="./data/tags.js"></script>
  <script>
    const COLORS = [
      { bg: "#F44336", fg: "white" },
      { bg: "#E91E63", fg: "white" },
      { bg: "#9C27B0", fg: "white" },
      { bg: "#673AB7", fg: "white" },
      { bg: "#3F51B5", fg: "white" },
      { bg: "#2196F3", fg: "white" },
      { bg: "#03A9F4", fg: "white" },
      { bg: "#00BCD4", fg: "white" },
      { bg: "#009688", fg: "white" },
      { bg: "#4CAF50", fg: "white" },
      { bg: "#8BC34A", fg: "#222" },
      { bg: "#CDDC39", fg: "#222" },
      { bg: "#FFEB3B", fg: "#222" },
      { bg: "#FFC107", fg: "#222" },
      { bg: "#FF9800", fg: "white" },
      { bg: "#FF5722", fg: "white" },
      { bg: "#795548", fg: "white" },
      { bg: "#9E9E9E", fg: "white" },
      { bg: "#607D8B", fg: "white" },
    ];
    $(function() {
      drawTagMenu();
      drawTagSections();
      findByIds(
        [
          "2c8d4d783be7ce4fc9ea",
          "0bf1703cb8d6f84afbc5",
        ],
        '.recommend-1[role=articles]',
        'Êñ∞Âçí„Ç®„É≥„Ç∏„Éã„Ç¢Âêë„ÅëÊâãÁ¥ô'
      );
      findByIds(
        [
          "fb949aa1a53f1f71c796",
          "aa2f81cf1e3974b8ad3a",
          "937354cc180c8bee823b",
          "b1c94328f273c750286b",
        ],
        '.recommend-2[role=articles]',
        'Êñ∞Âçí„Ç®„É≥„Ç∏„Éã„Ç¢Âêë„ÅëË®ò‰∫ã'
      );
      findByIds(
        [
          "cafccb1ee631d9f61190",
          "422b5427024d29da6a6e",
        ],
        '.recommend-3[role=articles]',
        '„Éë„Ç§„Çª„É≥Âêë„ÅëË®ò‰∫ã'
      );
      findByIds(
        [
          "34b40446337a59213a75",
          "f8411523cce000de750e",
          "5b11d2e1aace73c36340",
        ],
        '.recommend-4[role=articles]',
        '...„ÅØÈõ£„Åó„ÅÑ„Ç∑„É™„Éº„Ç∫'
      );
      findByIds(
        [
          "03aae7b9e3c70c55f513",
          "3378ea55b1240d7360a1",
        ],
        '.recommend-3[role=articles]',
        'Âñ∂Ê•≠AÁü≠Á∑®„Ç∑„É™„Éº„Ç∫'
      );
      initKeywordFilter();

      function initKeywordFilter() {
        let keyword = "";
        let timerId = -1;
        $('#keyword').on('keyup', function(e) {
          if(timerId != -1) {
            clearTimeout(timerId);
          }

          keyword = $(this).val();

          timerId = setTimeout(function() {
            const re = new  RegExp(keyword, 'i');
            const filteredArticles = keyword ? ARTICLES.filter(a => re.test(a.title) || re.test(a.body)) : [] ;
            drawArticles(filteredArticles, '.search-result[role=articles]', `„Ç≠„Éº„ÉØ„Éº„Éâ : ${keyword}`);
          }, 500);
        });

      }

      function searchByTagSection(tagSection) {
        console.log('+ searchByTagSection', tagSection);
        const tags = TAGS[tagSection];

        const searchedArticles = ARTICLES.filter(a => a.tags.some(t => tags.includes(t.name))).sort();
        drawArticles(searchedArticles, '.search-result[role=articles]', `„Ç´„ÉÜ„Ç¥„É™ : ${tagSection}`);
      }
      function searchByTag(tag) {
        console.log('+ searchByTag', tag);

        const searchedArticles = ARTICLES.filter(a => a.tags.some(t => t.name === tag)).sort();
        drawArticles(searchedArticles, '.search-result[role=articles]', `„Çø„Ç∞ : ${tag}`);
      }
      function findByIds(ids, target, label) {
        console.log('+ findByIds', ids);

        const foundArticles = ARTICLES.filter(a => ids.includes(a.id)).sort();
        drawArticles(foundArticles, target, label);
      }

      function drawTagMenu() {
        const articleTags = ARTICLES.flatMap(a => a.tags.map(t => t.name));
        const $tagMenu = $('[role=tag-menu]');

        console.log(articleTags);

        for(const i in Object.keys(TAGS)) {
          const section = Object.keys(TAGS)[i];
          const color = COLORS[i % COLORS.length];
          const $section = $(`
            <li class="tag-menu-section">
              <div name="${section}" class="name" style="background-color:${color.bg}; color:${color.fg}">${section}</div>
              <ul class="tags-container"></ul>
            </li>
          `);
          const $tags = $('<ul class="tags-container"></ul>');
          for(const tag of TAGS[section]) {
            const count = articleTags.filter(t => t == tag).length;
            if(count > 0) {
              $tags.append(`<li class="tag-menu-tag"><a name="${tag}"><span>${tag}</span><span>${count}</span></a></li>`);
            }
          }
          $section.append($tags);
          $tagMenu.append($section);
        }

        $tagMenu.find('li.tag-menu-section > .name').on('click', function(e) {
          const tagSection = $(this).attr('name');
          searchByTagSection(tagSection);

          $('.search-result[role=articles]')[0].scrollIntoView({ behavior: 'smooth' });
        });
        $tagMenu.find('li.tag-menu-section .tag-menu-tag > a').on('click', function(e) {
          const tag = $(this).attr('name');
          searchByTag(tag);

          $('.search-result[role=articles]')[0].scrollIntoView({ behavior: 'smooth' });
        });

      }

      function drawTagSections() {
        const $tagSections = $('[role=tag-sections]');
        const $tagsContainer = $('[role=tags-container]');

        for(const i in Object.keys(TAGS)) {
          const section = Object.keys(TAGS)[i];
          const color = COLORS[i % COLORS.length];

          $tagSections.append(`
            <li>
              <div name="${section}" class="tag-section" style="background-color:${color.bg}; color:${color.fg}">${section}</div>
            </li>
          `);
        }
        $('.tag-section', $tagSections).on('click', function(e) {
          const tagSection = $(this).attr('name');
          $(`[name=${tagSection}]`, 'nav [role=tag-menu]')[0].scrollIntoView({ behavior: 'smooth' });

          searchByTagSection(tagSection);
        });
      }

      function drawArticles(articles, target, label) {
        console.log('+ drawArticles', articles);
        const $articles = $(target).empty();
        const $label = $(`<label>${label}</label>`);
        const $articlesContainer = $('<ul class="articles-container"></ul>');

        for(const article of articles) {
          const _tags = article.tags.map(tag => {
            return `
              <li>
                <div name="${tag.name}" class="article-tag">${tag.name}</div>
              </li>
            `;
          }).sort().join('');
          $articlesContainer.append(`
            <li>
              <a role="qiita-link" data-id="${article.id}" href="${article.url}" target="qiita">
                <span>${article.title}</span>
                <ul class="article-tags-container">${_tags}</ul>
              </a>
            </li>
          `);
        }
        $articles.append($label);
        $articles.append($articlesContainer);

        $articles.find('.article-tag').on('click', function(e) {
          e.stopPropagation();
          e.preventDefault();
          
          const tag = $(this).attr('name');
          searchByTag(tag);

          $('.search-result[role=articles]')[0].scrollIntoView({ behavior: 'smooth' });
        })
      }
    });
  </script>
</body>
</html>