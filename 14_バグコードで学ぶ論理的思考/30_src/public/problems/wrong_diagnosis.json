{
  "id": "wrong_diagnosis",
  "level": "advanced",
  "title": "誤った原因分析",
  "description": "以下は実際の障害調査報告です。\n\n【障害報告】\nユーザーから「年齢欄に何も入力せずに登録できてしまった」との報告がありました。\n\n【調査結果（報告者）】\n年齢のバリデーション条件が不完全で、空の入力をチェックしていない可能性があります。\n\n【修正提案（報告者）】\nvalidateAge関数に空文字列チェックを追加する。\n\n---\n\nしかし、この分析は表面的です。コードをよく読んで、真の原因を突き止め、正しく修正してください。\n\n※ 仕様：registerUser関数は、nameとageを受け取り、ageが0～120の範囲内の数値であればユーザーオブジェクトを返す。範囲外または無効な値の場合はエラーを投げる。",
  "initialCode": "function validateAge(age) {\n  if (age < 0 || age > 120) {\n    return false;\n  }\n  return true;\n}\n\nfunction registerUser(name, age) {\n  if (!validateAge(age)) {\n    throw new Error('無効な年齢です');\n  }\n  return { name: name, age: age };\n}\n\nfunction testRegister() {\n  // HTMLフォームから取得した値（未入力）\n  const userAge = '';\n  const result = registerUser('Bob', userAge);\n  return result.age;\n}",
  "hint": "空文字列と数値の比較がどうなるか考えてください。'' < 0 や '' > 120 はどう評価されますか？また、仕様では「数値」を期待していますが、空文字列は数値ですか？",
  "explanation": "この問題の教訓は **「表面的な対処ではなく、根本原因を突き止める」** ことです。\n\n【誤った診断】\n報告者は「空の入力が登録できた」という症状から、「空文字列チェックがない」と判断しました。これは症状への対処療法的な分析です。\n\n【真の原因】\n- userAgeが空文字列 `''` として渡されている\n- JavaScriptでは、`'' < 0` → false、`'' > 120` → false\n- どちらも false なので、`age < 0 || age > 120` は false になり、バリデーションを通過してしまう\n- 結果として、`age: ''`（空文字列）がそのまま登録される\n\n根本的な問題は、**型のチェックが行われていない**ことです。空文字列だけでなく、`'abc'` などの非数値文字列も同様に通過してしまいます。\n\n【誤った修正（対処療法）】\n```javascript\nfunction validateAge(age) {\n  if (age === '' || age < 0 || age > 120) {  // 空文字列チェックを追加\n    return false;\n  }\n  return true;\n}\n```\nこれでは空文字列は弾けますが、`'abc'` などの他の無効な値は通過してしまいます。\n\n【正しい修正（根本対処）】\nregisterUser関数で、型を数値に変換し、NaNチェックを行う：\n```javascript\nfunction registerUser(name, age) {\n  const numAge = Number(age);\n  if (isNaN(numAge) || !validateAge(numAge)) {\n    throw new Error('無効な年齢です');\n  }\n  return { name: name, age: numAge };\n}\n```\n\n【実践での教訓】\n1. **症状ではなく原因を直す** - 「空文字列チェック」は対処療法、「型チェック」が根本対策\n2. **仕様を基準にする** - 「数値であるべき」という仕様から、型変換+バリデーションが必要\n3. **テストケースを広げる** - 空文字列だけでなく、'abc'、null、undefined なども考慮\n4. **JavaScriptの型変換を理解する** - 暗黙の型変換の落とし穴を知る",
  "testCases": [
    {
      "input": [],
      "expectedOutput": 0,
      "description": "空文字列が0として扱われるべき（現状は空文字列のまま登録される）"
    }
  ]
}
