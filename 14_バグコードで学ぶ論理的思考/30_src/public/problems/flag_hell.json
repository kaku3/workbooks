{
  "id": "flag_hell",
  "title": "フラグ管理の混乱",
  "level": "advanced",
  "description": "以下はユーザーの権限を管理するコードです。権限は以下の3つのフラグで管理されています：\n\n- isLoggedIn: ログイン済みかどうか\n- isPremium: プレミアム会員かどうか  \n- canAccessPremiumContent: プレミアムコンテンツにアクセス可能かどうか\n\n仕様：\n- ログインすると、DBからユーザー情報を復元する\n- プレミアム会員になると、DBに保存される\n- ログアウトすると、全ての状態をクリアする\n- プレミアム会員かつログイン中の場合のみ、プレミアムコンテンツにアクセス可能\n\n現在、一度プレミアム会員になったユーザーが、ログアウト後に再ログインすると、なぜかプレミアムコンテンツにアクセスできません。",
  "initialCode": "// 簡易ユーザーデータベース\nconst DB = {\n  'user1': { isPremium: false }\n};\n\nclass UserSession {\n  constructor() {\n    this.username = null;\n    this.isLoggedIn = false;\n    this.isPremium = false;\n    this.canAccessPremiumContent = false;\n  }\n\n  // ログイン処理\n  login(username, password) {\n    // パスワードチェック（簡略化）\n    if (username && password && DB[username]) {\n      this.username = username;\n      this.isLoggedIn = true;\n      \n      // DBからユーザー情報を復元\n      const userData = DB[username];\n      this.isPremium = userData.isPremium;\n      \n      console.log('ログイン成功');\n      return true;\n    }\n    return false;\n  }\n\n  // プレミアム会員登録\n  upgradeToPremium() {\n    if (this.isLoggedIn) {\n      this.isPremium = true;\n      this.canAccessPremiumContent = true;\n      \n      // DBに保存\n      DB[this.username].isPremium = true;\n      \n      console.log('プレミアム会員になりました');\n      return true;\n    }\n    console.log('ログインが必要です');\n    return false;\n  }\n\n  // ログアウト処理\n  logout() {\n    this.username = null;\n    this.isLoggedIn = false;\n    this.isPremium = false;\n    this.canAccessPremiumContent = false;\n    console.log('ログアウトしました');\n  }\n\n  // プレミアムコンテンツのアクセスチェック\n  canAccessPremium() {\n    return this.canAccessPremiumContent && this.isLoggedIn;\n  }\n}\n\nfunction testPremiumAccess() {\n  const session = new UserSession();\n  \n  // ステップ1: ログイン\n  session.login('user1', 'pass');\n  \n  // ステップ2: プレミアム会員登録\n  session.upgradeToPremium();\n  \n  // ステップ3: 一旦ログアウト\n  session.logout();\n  \n  // ステップ4: 再度ログイン（DBから復元される）\n  session.login('user1', 'pass');\n  \n  // プレミアムコンテンツにアクセス可能か？\n  return session.canAccessPremium();\n}",
  "hint": "canAccessPremium()メソッドの実装を見てください。本当に canAccessPremiumContent フラグを使う必要がありますか？isLoggedIn と isPremium だけで判定できませんか？",
  "explanation": "この問題の教訓は**「不要なフラグによる複雑化」**と**「導出可能な値をフラグにしてしまう設計ミス」**です。\n\n【バグの内容】\n`canAccessPremium()` メソッドが正しく実装されていれば、`canAccessPremiumContent` フラグは一切不要です。\n\n実は、このコードの本質的な問題は「`canAccessPremiumContent` というフラグが存在すること」そのものです。このフラグは `isLoggedIn && isPremium` で常に導出できるため、別途管理する必要がありません。\n\nしかし、このフラグが存在するせいで、開発者は以下の間違いを犯しています：\n- upgradeToPremium() で `canAccessPremiumContent = true` を設定\n- logout() で `canAccessPremiumContent = false` をクリア\n- **login() で `canAccessPremiumContent` の復元を忘れる**\n\nつまり、不要なフラグを管理しようとした結果、管理漏れが発生しています。\n\n【実行トレース】\n```\n1. login('user1', 'pass')\n   → isLoggedIn = true, isPremium = false\n   → canAccessPremium() = false（正しい）\n   \n2. upgradeToPremium()\n   → isPremium = true, canAccessPremiumContent = true\n   → DB保存\n   \n3. logout()\n   → 全フラグクリア\n   \n4. login('user1', 'pass')  \n   → isLoggedIn = true, isPremium = true（DBから復元）\n   → canAccessPremiumContent = false（復元忘れ）\n   → canAccessPremium() = true のはずが...\n   → 現在の実装では canAccessPremiumContent && isLoggedIn なので false\n```\n\n【正しい解決策】\nフラグを減らし、canAccessPremium() を正しく実装する：\n\n```javascript\nclass UserSession {\n  constructor() {\n    this.username = null;\n    this.isLoggedIn = false;\n    this.isPremium = false;\n    // canAccessPremiumContent フラグは削除！\n  }\n\n  login(username, password) {\n    if (username && password && DB[username]) {\n      this.username = username;\n      this.isLoggedIn = true;\n      this.isPremium = DB[username].isPremium;\n      return true;\n    }\n    return false;\n  }\n\n  upgradeToPremium() {\n    if (this.isLoggedIn) {\n      this.isPremium = true;\n      DB[this.username].isPremium = true;\n      // canAccessPremiumContent の設定は不要！\n      return true;\n    }\n    return false;\n  }\n\n  logout() {\n    this.username = null;\n    this.isLoggedIn = false;\n    this.isPremium = false;\n    // canAccessPremiumContent のクリアも不要！\n  }\n\n  canAccessPremium() {\n    // フラグではなく、その場で計算\n    return this.isLoggedIn && this.isPremium;\n  }\n}\n```\n\n【実践での教訓】\n1. **導出可能な値はフラグにしない** - A && B で求められる値を、別のフラグ C として管理しない\n2. **フラグは最小限に** - フラグが増えるほど、状態管理が複雑になりバグが混入しやすい\n3. **単一責任の原則** - DBに保存すべき状態（isPremium）と、計算で求められる状態（アクセス権）を区別する\n4. **テストを書く** - 様々な状態遷移パターンをテストして、不整合を早期発見\n5. **コードレビューで指摘** - 「このフラグ、計算で求められませんか？」と問いかける",
  "testCases": [
    {
      "input": [],
      "expectedOutput": true,
      "description": "プレミアム会員登録したユーザーが、ログアウト→再ログイン後もプレミアムコンテンツにアクセスできるべき"
    }
  ]
}
